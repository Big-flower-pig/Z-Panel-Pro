#!/bin/bash
# ==============================================================================
# Z-Panel Pro - æ–‡ä»¶é”æ¨¡å?# ==============================================================================
# @description    æ–‡ä»¶é”ç®¡ç†ï¼Œé˜²æ­¢å¹¶å‘æ‰§è¡Œ
# @version       7.1.0-Enterprise
# @author        Z-Panel Team
# ==============================================================================

# ==============================================================================
# è·å–æ–‡ä»¶é”?# @return: 0ä¸ºæˆåŠŸï¼Œ1ä¸ºå¤±è´?# ==============================================================================
acquire_lock() {
    # æ‰“å¼€é”æ–‡ä»¶æè¿°ç¬¦
    if ! eval "exec ${LOCK_FD}>\"${LOCK_FILE}\"" 2>/dev/null; then
        log_error "æ— æ³•åˆ›å»ºé”æ–‡ä»? ${LOCK_FILE}"
        return 1
    fi

    # å°è¯•è·å–éé˜»å¡é”
    if ! flock -n "${LOCK_FD}" 2>/dev/null; then
        local pid
        pid=$(cat "${LOCK_FILE}" 2>/dev/null || echo "unknown")
        log_error "è„šæœ¬å·²åœ¨è¿è¡Œä¸?(PID: ${pid})"
        log_error "å¦‚éœ€é‡æ–°å¯åŠ¨ï¼Œè¯·å…ˆè¿è¡? rm -f ${LOCK_FILE}"
        return 1
    fi

    # å†™å…¥å½“å‰PID
    echo $$ > "${LOCK_FILE}" 2>/dev/null

    log_debug "æ–‡ä»¶é”å·²è·å– (PID: $$)"
    return 0
}

# ==============================================================================
# é‡Šæ”¾æ–‡ä»¶é”?# ==============================================================================
release_lock() {
    if flock -u "${LOCK_FD}" 2>/dev/null; then
        rm -f "${LOCK_FILE}" 2>/dev/null
        log_debug "æ–‡ä»¶é”å·²é‡Šæ”¾"
    fi
}

# ==============================================================================
# æ£€æŸ¥æ˜¯å¦æŒæœ‰é”
# @return: 0ä¸ºæŒæœ‰ï¼Œ1ä¸ºæœªæŒæœ‰
# ==============================================================================
is_lock_held() {
    flock -n "${LOCK_FD}" 2>/dev/null
}

# ==============================================================================
# è·å–é”æ–‡ä»¶ä¸­çš„PID
# @return: PIDæˆ–ç©ºå­—ç¬¦ä¸?# ==============================================================================
get_lock_pid() {
    cat "${LOCK_FILE}" 2>/dev/null || echo ""
}

# ==============================================================================
# å¼ºåˆ¶é‡Šæ”¾é”ï¼ˆå±é™©æ“ä½œï¼?# @return: 0ä¸ºæˆåŠŸï¼Œ1ä¸ºå¤±è´?# ==============================================================================
force_release_lock() {
    log_warn "å¼ºåˆ¶é‡Šæ”¾æ–‡ä»¶é”?

    local lock_pid
    lock_pid=$(get_lock_pid)

    if [[ -n "${lock_pid}" ]] && is_process_running "${lock_pid}"; then
        log_warn "é”æ–‡ä»¶ä¸­çš„è¿›ç¨?${lock_pid} ä»åœ¨è¿è¡Œ"
        if ! ui_confirm "ç¡®è®¤å¼ºåˆ¶é‡Šæ”¾ï¼Ÿè¿™å¯èƒ½å¯¼è‡´æ•°æ®æŸå"; then
            return 1
        fi
    fi

    flock -u "${LOCK_FD}" 2>/dev/null
    rm -f "${LOCK_FILE}" 2>/dev/null
    log_info "æ–‡ä»¶é”å·²å¼ºåˆ¶é‡Šæ”¾"
    return 0
}